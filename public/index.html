<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Pemantauan Tracker Sampah Plastik Laut</title>
  <!-- PROTEKSI LOGIN -->
  <script>
    if (!localStorage.getItem('isLoggedIn')) {
      alert('Silakan login terlebih dahulu.');
      window.location.href = '/login.html';
    }
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #212529;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 12px;
      gap: 12px;
    }
    .header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0 4px;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
      gap: 8px;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-unsoed {
      width: 40px;
      height: auto;
      display: block;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
      color: #0d6efd;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .interval-control {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0 8px;
    }
    .interval-input {
      background: transparent;
      border: none;
      color: #212529;
      width: 60px;
      font-size: 14px;
      outline: none;
      text-align: right;
    }
    .btn {
      padding: 6px 10px;
      background: #0d6efd;
      border: 1px solid #0d6efd;
      border-radius: 6px;
      color: white;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn:hover {
      background: #0b5ed7;
    }
    .btn-icon {
      width: 32px;
      height: 32px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      cursor: pointer;
    }
    .btn-icon:hover {
      background: #0d6efd;
      color: white;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      font-size: 13px;
    }
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .status-connected {
      background: #198754;
      box-shadow: 0 0 8px #198754;
    }
    .status-disconnected {
      background: #dc3545;
      box-shadow: 0 0 8px #dc3545;
    }
    .devices-count {
      color: #0d6efd;
      font-weight: 600;
    }
    .main-content {
      display: flex;
      flex: 1;
      gap: 12px;
      overflow: hidden;
    }
    .devices-panel {
      width: 260px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #0d6efd;
    }
    .device-list {
      flex: 1;
      overflow-y: auto;
    }
    .device-item {
      padding: 8px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .device-info {
      flex: 1;
      min-width: 0;
    }
    .device-id {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .device-time {
      font-size: 10px;
      color: #6c757d;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .map-area {
      flex: 1;
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    #map {
      height: 100%;
      width: 100%;
      touch-action: none;
    }
    .map-controls {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .map-btn {
      width: 36px;
      height: 36px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      color: #212529;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: 600;
      font-size: 18px;
    }
    .map-btn:hover {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    #log-panel {
      height: 100px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 8px;
      overflow-y: auto;
      font-size: 11px;
      color: #212529;
    }
    .log-entry {
      margin-bottom: 3px;
      padding: 2px 0;
      border-bottom: 1px solid #dee2e6;
    }
    .log-time {
      color: #6c757d;
      font-size: 10px;
    }
    .footer {
      text-align: right;
      font-size: 11px;
      color: #6c757d;
      padding: 0 4px;
    }

    @media (max-width: 768px) {
      .container { padding: 8px; gap: 8px; }
      .header { gap: 8px; }
      .header-top { flex-direction: column; align-items: stretch; }
      .title { font-size: 18px; text-align: center; }
      .controls { justify-content: center; gap: 8px; flex-wrap: wrap; }
      .interval-control { width: 100%; max-width: none; margin: 0 auto; justify-content: center; }
      .btn-icon { width: 30px; height: 30px; font-size: 14px; }
      .status-bar { padding: 8px 10px; font-size: 12px; }
      .main-content { flex-direction: column; gap: 10px; }
      .devices-panel { width: 100%; max-height: 200px; padding: 10px; }
      .panel-title { font-size: 14px; }
      .device-item { padding: 6px; gap: 6px; }
      .device-id { font-size: 11px; }
      .device-time { font-size: 9px; }
      #log-panel { height: 80px; padding: 6px; font-size: 10px; }
      .log-time { font-size: 9px; }
      .footer { font-size: 10px; text-align: center; }
      .map-controls { bottom: 12px; right: 12px; gap: 5px; }
      .map-btn { width: 32px; height: 32px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <div class="logo-container">
          <img src="/assets/images/logounsoed.png" alt="UNSOED" class="logo-unsoed">
          <div class="title">Dashboard Pemantauan Tracker Sampah Plastik Laut</div>
        </div>
        <div class="controls">
          <div class="interval-control">
            <span style="color:#6c757d;">Interval (detik):</span>
            <input type="number" class="interval-input" id="interval-input" min="1" value="30">
            <div class="btn" id="set-interval">Set</div>
          </div>
          <div class="btn" id="led-on">LED ON</div>
          <div class="btn" id="led-off">LED OFF</div>
          <div class="btn-icon" id="download-data" title="Download last 24h data">üì•</div>
          <div class="btn-icon" id="show-info">‚ÑπÔ∏è</div>
        </div>
      </div>

      <div class="status-bar">
        <div class="connection-status">
          <div class="status-dot status-disconnected"></div>
          <span id="status-text">Disconnected</span>
        </div>
        <div class="devices-count">Devices: <span id="device-count">0</span></div>
      </div>
    </div>

    <div class="main-content">
      <div class="devices-panel">
        <div class="panel-title">Active Devices</div>
        <div class="device-list" id="device-list">
          <div style="color:#6c757d;text-align:center;padding:20px;">No devices connected</div>
        </div>
      </div>

      <div class="map-area">
        <div id="map"></div>
        <div class="map-controls">
          <div class="map-btn" id="zoom-in">+</div>
          <div class="map-btn" id="zoom-out">‚àí</div>
          <div class="map-btn" id="toggle-layers">üó∫Ô∏è</div>
        </div>
      </div>
    </div>

    <div id="log-panel"></div>

    <div class="footer">¬© 2025 Tracker Sampah Plastik Laut - Jumantoro L1C022006</div>
  </div>

  <script src="https://trackerfpikunsoed.my.id/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === INISIALISASI GLOBAL ===
    const colorPalette = ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#6610f2'];
    const markers = {};
    const polylines = {};
    const devices = new Set();
    const deviceHistory = {};
    let selectedDevice = null;
    let latestDeviceData = {};
    const deviceLastSeen = {};

    const statusDot = document.querySelector('.status-dot');
    const statusText = document.getElementById('status-text');
    const deviceCountEl = document.getElementById('device-count');
    const deviceListEl = document.getElementById('device-list');
    const logPanel = document.getElementById('log-panel');

    // === PETA ===
    const map = L.map('map', {
      scrollWheelZoom: false,
      dragging: true,
      touchZoom: true,
      doubleClickZoom: true
    }).setView([-7.7167, 109.0167], 12);

    // === LAYER PETA DENGAN ATRIBUSI RESMI ===
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
    });

    const positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    osm.addTo(map);

    const baseLayers = {
      "OpenStreetMap": osm,
      "OpenTopoMap": topo,
      "CartoDB Positron": positron,
      "Satellite (ESRI)": satellite
    };

    const layerControl = L.control.layers(baseLayers).addTo(map);
    layerControl.collapse();

    // === EVENT MAP CONTROLS ===
    document.getElementById('toggle-layers').addEventListener('click', () => {
      layerControl._expanded ? layerControl.collapse() : layerControl.expand();
    });

    document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
    document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());

    // === FUNGSI UTILITAS ===
    function addLog(message) {
      const now = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${now}]</span> ${message}`;
      logPanel.appendChild(entry);
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    function getDarkerColor(hex) {
      let c = hex.replace('#', '');
      if (c.length === 3) c = c.split('').map(x => x + x).join('');
      const r = Math.floor(parseInt(c.substr(0,2), 16) * 0.6);
      const g = Math.floor(parseInt(c.substr(2,2), 16) * 0.6);
      const b = Math.floor(parseInt(c.substr(4,2), 16) * 0.6);
      return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
    }

    function createRealisticBottleMarker(color) {
      const bottleSvg = `
        <svg width="30" height="40" viewBox="0 0 100 130" xmlns="http://www.w3.org/2000/svg">
          <path d="M50,5 C45,5 40,10 40,15 L40,110 C40,115 45,120 50,120 C55,120 60,115 60,110 L60,15 C60,10 55,5 50,5 Z" 
                fill="${color}" stroke="#000" stroke-width="2"/>
          <path d="M42,110 L42,80 C42,75 58,75 58,80 L58,110 Z" 
                fill="#3b82f6" opacity="0.7"/>
          <rect x="42" y="0" width="16" height="8" rx="2" 
                fill="${getDarkerColor(color)}" stroke="#000" stroke-width="1"/>
          <path d="M45,15 L45,100 C45,105 55,105 55,100 L55,15 Z" 
                fill="white" opacity="0.2"/>
        </svg>
      `;
      return L.divIcon({
        className: 'custom-bottle-marker',
        html: `<div style="background: transparent; display: flex; align-items: center; justify-content: center; width: 36px; height: 44px;">${bottleSvg}</div>`,
        iconSize: [36, 44],
        iconAnchor: [18, 42]
      });
    }

    // === TAMPILKAN DAFTAR DEVICE ===
    function updateDeviceList() {
      const allDeviceIds = new Set([...devices, ...Object.keys(latestDeviceData)]);
      if (allDeviceIds.size === 0) {
        deviceListEl.innerHTML = '<div style="color:#6c757d;text-align:center;padding:20px;">No devices connected</div>';
        selectedDevice = null;
        deviceCountEl.textContent = '0';
        return;
      }

      let html = '';
      const deviceArray = Array.from(allDeviceIds);
      if (!selectedDevice && deviceArray.length > 0) selectedDevice = deviceArray[0];
      deviceCountEl.textContent = deviceArray.length;

      deviceArray.forEach((id, idx) => {
        const lastSeen = deviceLastSeen[id] || (latestDeviceData[id] ? new Date(latestDeviceData[id].waktu_gps).getTime() : null);
        let timeStr = '‚Äî';
        let isOnline = false;
        if (lastSeen) {
          const diffSec = Math.floor((Date.now() - lastSeen) / 1000);
          isOnline = diffSec < 300;
          if (diffSec < 60) timeStr = `${diffSec} detik lalu`;
          else if (diffSec < 3600) timeStr = `${Math.floor(diffSec / 60)} menit lalu`;
          else timeStr = `${Math.floor(diffSec / 3600)} jam lalu`;
        }
        const statusColor = isOnline ? '#198754' : '#dc3545';
        const color = colorPalette[idx % colorPalette.length];

        const bottleSvg = `
          <svg width="22" height="30" viewBox="0 0 100 130" xmlns="http://www.w3.org/2000/svg">
            <path d="M50,5 C45,5 40,10 40,15 L40,110 C40,115 45,120 50,120 C55,120 60,115 60,110 L60,15 C60,10 55,5 50,5 Z" 
                  fill="${color}" stroke="#000" stroke-width="1.5"/>
            <path d="M42,110 L42,80 C42,75 58,75 58,80 L58,110 Z" 
                  fill="#3b82f6" opacity="0.7"/>
            <rect x="42" y="0" width="16" height="8" rx="2" 
                  fill="${getDarkerColor(color)}" stroke="#000" stroke-width="0.8"/>
            <text x="50" y="55" text-anchor="middle" font-family="Arial" font-size="7" fill="#333">500ml</text>
            <text x="50" y="65" text-anchor="middle" font-family="Arial" font-size="5" fill="#333">PLASTIC</text>
          </svg>
        `;

        html += `
          <div class="device-item" onclick="window.location.href='device.html?id=${id}'">
            <div style="width:26px; height:34px; display:flex; align-items:center; justify-content:center;">
              ${bottleSvg}
            </div>
            <div class="device-info">
              <div class="device-id">${id}</div>
              <div class="device-time">
                <div style="width:6px; height:6px; border-radius:50%; background:${statusColor};"></div>
                <span>${timeStr}</span>
              </div>
            </div>
          </div>
        `;
      });
      deviceListEl.innerHTML = html;
    }

    // === SOCKET.IO ===
    const socket = io('https://trackerfpikunsoed.my.id', {
      transports: ['websocket'],
      secure: true
    });

    socket.on('connect', () => {
      statusDot.className = 'status-dot status-connected';
      statusText.textContent = 'Connected to MQTT Broker';
      addLog('‚úÖ Connected to server');
    });

    socket.on('disconnect', () => {
      statusDot.className = 'status-dot status-disconnected';
      statusText.textContent = 'Disconnected';
      addLog('‚ùå Disconnected from server');
    });

    socket.on('connect_error', (err) => {
      statusText.textContent = 'Connection failed';
      statusDot.className = 'status-dot status-disconnected';
      addLog(`‚ö†Ô∏è Connection error: ${err.message || err}`);
    });

    socket.on('newLocation', (data) => {
      if (!data.device_id || !data.latitude || !data.longitude) return;

      deviceLastSeen[data.device_id] = Date.now();

      if (!deviceHistory[data.device_id]) deviceHistory[data.device_id] = [];
      deviceHistory[data.device_id].push(data);
      if (deviceHistory[data.device_id].length > 50) deviceHistory[data.device_id].shift();
      devices.add(data.device_id);
      latestDeviceData[data.device_id] = {
        latitude: data.latitude,
        longitude: data.longitude,
        waktu_gps: data.waktu || new Date().toISOString(),
        seconds_ago: 0
      };
      deviceCountEl.textContent = devices.size;
      updateDeviceList();

      const deviceArray = Array.from(devices);
      const idx = deviceArray.indexOf(data.device_id);
      const color = colorPalette[idx % colorPalette.length];

      if (!polylines[data.device_id]) {
        polylines[data.device_id] = L.polyline([], { color, weight: 3, opacity: 0.7 }).addTo(map);
      }
      polylines[data.device_id].setLatLngs(deviceHistory[data.device_id].map(d => [d.latitude, d.longitude]));

      if (!markers[data.device_id]) {
        markers[data.device_id] = L.marker([data.latitude, data.longitude], {
          icon: createRealisticBottleMarker(color)
        }).bindPopup(`
          <div style="font-family:'Inter',sans-serif; min-width:200px; padding:12px; background:#ffffff; color:#212529; border-radius:8px; border:1px solid #dee2e6;">
            <h3 style="color:${color}; margin:0 0 8px; font-weight:700;">${data.device_id}</h3>
            <div><strong>Lat:</strong> ${data.latitude.toFixed(5)}</div>
            <div><strong>Lon:</strong> ${data.longitude.toFixed(5)}</div>
            <div style="margin-top:6px; font-size:12px; color:#6c757d;">
              ${data.waktu ? new Date(data.waktu).toLocaleString() : new Date().toLocaleString()}
            </div>
          </div>
        `).addTo(map);
      } else {
        markers[data.device_id].setLatLng([data.latitude, data.longitude]);
      }

      addLog(`üìç ${data.device_id} ‚Üí [${data.latitude.toFixed(5)}, ${data.longitude.toFixed(5)}]`);
    });

    // === FETCH DATA TERAKHIR DARI DATABASE ===
    async function loadLatestDevices() {
      try {
        const res = await fetch('https://trackerfpikunsoed.my.id/api/latest-devices');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const devicesData = await res.json();
        const now = Date.now();
        latestDeviceData = {};

        for (const d of devicesData) {
          const deviceId = d.device_id;
          const lastSeenTime = new Date(d.waktu_gps).getTime();
          const diffSec = Math.floor((now - lastSeenTime) / 1000);
          const isOnline = diffSec < 300;

          latestDeviceData[deviceId] = {
            latitude: parseFloat(d.latitude),
            longitude: parseFloat(d.longitude),
            waktu_gps: d.waktu_gps,
            seconds_ago: diffSec
          };
          deviceLastSeen[deviceId] = lastSeenTime;
          devices.add(deviceId);

          const deviceArray = Array.from(devices);
          const idx = deviceArray.indexOf(deviceId);
          const color = colorPalette[idx % colorPalette.length];

          if (!markers[deviceId]) {
            markers[deviceId] = L.marker([d.latitude, d.longitude], {
              icon: createRealisticBottleMarker(color)
            }).bindPopup(`
              <div style="font-family:'Inter',sans-serif; min-width:200px; padding:12px; background:#ffffff; color:#212529; border-radius:8px; border:1px solid #dee2e6;">
                <h3 style="color:${color}; margin:0 0 8px; font-weight:700;">${deviceId}</h3>
                <div><strong>Lat:</strong> ${parseFloat(d.latitude).toFixed(5)}</div>
                <div><strong>Lon:</strong> ${parseFloat(d.longitude).toFixed(5)}</div>
                <div style="margin-top:6px; font-size:12px; color:#6c757d;">
                  ${new Date(d.waktu_gps).toLocaleString()}
                </div>
                <div style="margin-top:4px; font-size:11px; color:${isOnline ? '#198754' : '#dc3545'};">
                  Status: ${isOnline ? 'Online' : 'Offline'}
                </div>
              </div>
            `).addTo(map);
          } else {
            markers[deviceId].setLatLng([d.latitude, d.longitude]);
          }
        }

        updateDeviceList();
      } catch (err) {
        console.error('‚ùå Error fetching latest devices:', err);
        addLog('‚ö†Ô∏è Gagal memuat data perangkat terakhir dari database');
      }
    }

    loadLatestDevices();
    setInterval(updateDeviceList, 30000);

    // === EVENT LAINNYA ===
    document.getElementById('set-interval').addEventListener('click', () => {
      const input = document.getElementById('interval-input');
      const seconds = parseInt(input.value);
      if (isNaN(seconds) || seconds < 1) return alert('Masukkan interval minimal 1 detik');
      socket.emit('setInterval', { interval: seconds * 1000 });
      addLog(`‚è±Ô∏è Kirim perintah: atur interval = ${seconds} detik`);
    });

    document.getElementById('download-data').addEventListener('click', async () => {
      addLog('‚¨áÔ∏è Memulai unduh data 24 jam terakhir...');
      try {
        const response = await fetch('https://trackerfpikunsoed.my.id/api/download-last-24h');
        if (!response.ok) throw new Error('Server error');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tracker_data_24h.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        addLog('‚úÖ Data berhasil diunduh');
      } catch (err) {
        addLog(`‚ùå Gagal: ${err.message}`);
        alert('Gagal mengunduh data. Cek koneksi server.');
      }
    });

    document.getElementById('show-info').addEventListener('click', () => {
      alert('Projek Skripsi Jumantoro - L1C022006\n\nPERANCANGAN TRACKER SAMPAH PLASTIK DI LAUT BERBASIS INTERNET OF THINGS (IOT) DENGAN KOMUNIKASI MQTT');
    });

    document.getElementById('led-on').addEventListener('click', () => {
      if (!selectedDevice) return alert('‚ö†Ô∏è Tidak ada device aktif');
      socket.emit('ledControl', { deviceId: selectedDevice, state: 'on' });
      addLog(`üí° Kirim: LED ON ke ${selectedDevice}`);
    });

    document.getElementById('led-off').addEventListener('click', () => {
      if (!selectedDevice) return alert('‚ö†Ô∏è Tidak ada device aktif');
      socket.emit('ledControl', { deviceId: selectedDevice, state: 'off' });
      addLog(`üí° Kirim: LED OFF ke ${selectedDevice}`);
    });
  </script>
</body>
</html>